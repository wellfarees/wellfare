import server from "../server";

import { hash } from "bcrypt";
import { decryptSensitiveData } from "../utils/decryptSensitiveData";
import verifyJWT from "../utils/verifyJWT";

import { decodedToken } from "../types/jwt";

export default {
  Mutation: {
    changePassword: async (
      _: unknown,
      args: { jwt: string; password: string }
    ) => {
      const dToken = verifyJWT(args.jwt, "password");

      const id = (dToken as decodedToken).id;
      const newPassword = await hash(args.password, 10);
      const user = await server.db.user.update({
        where: {
          id,
        },
        data: {
          information: {
            update: {
              password: newPassword,
            },
          },
        },
      });

      return await decryptSensitiveData(user);
    },
  },
};
